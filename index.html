<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Team Customer Tracker</title>
<meta name="theme-color" content="#0a2a43"/>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<!-- QR Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { margin:0; font-family:"Segoe UI", sans-serif; background:#0a2a43; color:#fff; }
.container { padding:20px; max-width:400px; margin:auto; }
input, select, button { width:100%; padding:10px; margin:6px 0; border-radius:6px; border:none; }
button { background:#1a73e8; color:#fff; cursor:pointer; font-weight:bold; }
table { width:100%; margin-top:15px; border-collapse:collapse; }
th, td { padding:8px; border:1px solid #fff; text-align:left; }
th { background:#1a73e8; }
#qr-reader { width:100%; height:30px; display:none; margin:5px 0; }
</style>
</head>
<body>

<!-- Login -->
<div class="container" id="login-container">
<h2>Login</h2>
<input type="email" id="login-email" placeholder="Email"/>
<input type="password" id="login-password" placeholder="Password"/>
<button onclick="login()">Login</button>
<button onclick="signup()">Sign Up</button>
<button onclick="guestLogin()">Continue as Guest</button>
</div>

<!-- App -->
<div class="container" id="app-container" style="display:none;">
<h2>Team Customer Tracker</h2>

<label>Customer Name</label>
<input type="text" id="custName" placeholder="Enter customer name"/>

<label>MTN Number</label>
<input type="number" id="custNumber" placeholder="10-digit MTN number"/>

<label>IMEI</label>
<input type="text" id="custIMEI" placeholder="Scan or enter IMEI"/>
<button onclick="startScanner()">ðŸ“· Scan Barcode</button>
<div id="qr-reader"></div>

<label>Date Received</label>
<input type="date" id="custDate"/>

<label>Offer Taken?</label>
<select id="custOffer">
<option value="Yes">Yes</option>
<option value="No">No</option>
</select>

<button onclick="addEntry()">âž• Add Entry</button>
<button onclick="exportCSV()">ðŸ“‚ Export CSV</button>
<button onclick="exportPDF()">ðŸ“‘ Export PDF</button>
<button onclick="logout()">Logout</button>

<table id="dataTable">
<thead>
<tr><th>Name</th><th>Number</th><th>IMEI</th><th>Date</th><th>Offer</th><th>Promoter</th></tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
// ====== Firebase Config ======
const firebaseConfig = {
  apiKey: "AIzaSyCQyyaaoa-QIjPQ9UfHJXEwWAfCKPKc-u0",
  authDomain: "customer-follow-up-7ab17.firebaseapp.com",
  projectId: "customer-follow-up-7ab17",
  storageBucket: "customer-follow-up-7ab17.firebasestorage.app",
  messagingSenderId: "350957822054",
  appId: "1:350957822054:web:c5a3aca9deacebbe050da7",
  measurementId: "G-08FJBE5F17"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ====== Login & Signup ======
function login() {
  const email = document.getElementById("login-email").value;
  const pass = document.getElementById("login-password").value;
  auth.signInWithEmailAndPassword(email, pass)
  .then(() => initApp())
  .catch(e => alert(e.message));
}

function signup() {
  const email = document.getElementById("login-email").value;
  const pass = document.getElementById("login-password").value;
  auth.createUserWithEmailAndPassword(email, pass)
  .then(() => initApp())
  .catch(e => alert(e.message));
}

// ====== Guest Login ======
function guestLogin() {
  auth.currentUser = { email: "guest@example.com" };
  initApp();
}

// ====== Logout ======
function logout() {
  if(auth.signOut) { auth.signOut().then(()=>location.reload()); } 
  else { location.reload(); }
}

// ====== Initialize App ======
function initApp() {
  document.getElementById("login-container").style.display = "none";
  document.getElementById("app-container").style.display = "block";
  loadEntries();
}

// ====== Add Customer Entry ======
function addEntry() {
  const name = document.getElementById("custName").value.trim();
  const number = document.getElementById("custNumber").value.trim();
  const imei = document.getElementById("custIMEI").value.trim();
  const date = document.getElementById("custDate").value;
  const offer = document.getElementById("custOffer").value;
  if(!name || !number || number.length !== 10){ alert("Enter valid data."); return; }

  const promoter = auth.currentUser.email;
  db.collection("customers").add({name, number, imei, date, offer, promoter})
  .then(()=>{
    document.getElementById("custName").value="";
    document.getElementById("custNumber").value="";
    document.getElementById("custIMEI").value="";
    document.getElementById("custDate").value="";
  })
  .catch(e=>console.log(e));
}

// ====== Load Entries ======
function loadEntries() {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML="";
  db.collection("customers").orderBy("date","desc")
  .onSnapshot(snapshot=>{
    tbody.innerHTML="";
    snapshot.forEach(doc=>{
      const data=doc.data();
      const row = `<tr>
        <td>${data.name}</td>
        <td>${data.number}</td>
        <td>${data.imei}</td>
        <td>${data.date}</td>
        <td>${data.offer}</td>
        <td>${data.promoter}</td>
      </tr>`;
      tbody.insertAdjacentHTML("beforeend", row);
    });
  });
}

// ====== QR Scanner ======
function startScanner() {
  const html5QrCode = new Html5Qrcode("qr-reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width:200, height:25 } },
    qrCodeMessage=>{
      document.getElementById("custIMEI").value = qrCodeMessage;
      html5QrCode.stop();
      document.getElementById("qr-reader").style.display = "none";
    },
    errorMessage=>{ console.log(errorMessage); }
  );
  document.getElementById("qr-reader").style.display="block";
}

// ====== Export CSV ======
function exportCSV() {
  let rows=[["Name","Number","IMEI","Date","Offer","Promoter"]];
  document.querySelectorAll("#dataTable tbody tr").forEach(tr=>{
    rows.push([...tr.children].map(td=>td.innerText));
  });
  let csv = rows.map(r=>r.join(",")).join("\n");
  let blob = new Blob([csv], {type:"text/csv"});
  let link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download="customers.csv";
  link.click();
}

// ====== Export PDF ======
async function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("Customer Data",20,20);
  let y=30;
  document.querySelectorAll("#dataTable tbody tr").forEach(tr=>{
    let row=[...tr.children].map(td=>td.innerText).join(" | ");
    doc.text(row,20,y); y+=10;
  });
  doc.save("customers.pdf");
}
</script>
</body>
</html>