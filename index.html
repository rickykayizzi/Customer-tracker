<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Customer Tracker</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js"></script>
</head>
<body>
  <h1>ðŸ“± Customer Tracker</h1>

  <!-- Login -->
  <div id="loginSection">
    <input type="password" id="passwordInput" placeholder="Enter Password" />
    <button onclick="login()">Unlock</button>
  </div>

  <!-- Main app -->
  <div id="appSection" style="display:none;">
    <h2>Add New Entry</h2>
    <input id="custName" placeholder="Customer Name"><br>
    <input id="custPhone" placeholder="Phone Number"><br>
    <input id="custIMEI" placeholder="IMEI (up to 16 digits)" maxlength="16"><br>
    <input id="custOffer" placeholder="Offer"><br>
    <input type="date" id="custDate"><br>
    <input type="file" id="custReceipt" accept="image/*"><br>
    <button onclick="addEntry()">âž• Add Entry</button>
    <button onclick="logout()">ðŸ”’ Logout</button>

    <h2>ðŸ“‹ All Entries</h2>
    <table id="entriesTable" border="1">
      <thead>
        <tr>
          <th>Customer</th>
          <th>Phone</th>
          <th>IMEI</th>
          <th>Offer</th>
          <th>Date</th>
          <th>Receipt</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    // ðŸ”¹ Your Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCQyyaaoa-QIjPQ9UfHJXEwWAfCKPKc-u0",
      authDomain: "customer-follow-up-7ab17.firebaseapp.com",
      projectId: "customer-follow-up-7ab17",
      storageBucket: "customer-follow-up-7ab17.appspot.com",
      messagingSenderId: "350957822054",
      appId: "1:350957822054:web:c5a3aca9deacebbe050da7",
      measurementId: "G-08FJBE5F17"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let userId = null;

    // Simple password login
    function login() {
      const password = document.getElementById("passwordInput").value;
      if (password === "1234") { // ðŸ”‘ change this
        userId = "demoUser"; // static for now
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("appSection").style.display = "block";
        loadEntries();
      } else {
        alert("Wrong password!");
      }
    }
    window.login = login;

    function logout() {
      document.getElementById("loginSection").style.display = "block";
      document.getElementById("appSection").style.display = "none";
    }
    window.logout = logout;

    async function addEntry() {
      const name = document.getElementById("custName").value;
      const phone = document.getElementById("custPhone").value;
      const imei = document.getElementById("custIMEI").value;
      const offer = document.getElementById("custOffer").value;
      const date = document.getElementById("custDate").value;
      const file = document.getElementById("custReceipt").files[0];

      let receiptUrl = "";
      if (file) {
        const storageRef = ref(storage, `receipts/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        receiptUrl = await getDownloadURL(storageRef);
      }

      await addDoc(collection(db, "users", userId, "entries"), {
        customerName: name,
        phoneNumber: phone,
        imei: imei,
        offer: offer,
        date: date,
        receiptUrl: receiptUrl,
        timestamp: Date.now()
      });

      // Clear form
      document.getElementById("custName").value = "";
      document.getElementById("custPhone").value = "";
      document.getElementById("custIMEI").value = "";
      document.getElementById("custOffer").value = "";
      document.getElementById("custDate").value = "";
      document.getElementById("custReceipt").value = "";
    }
    window.addEntry = addEntry;

    function loadEntries() {
      const entriesRef = collection(db, "users", userId, "entries");
      onSnapshot(entriesRef, (snapshot) => {
        const tbody = document.querySelector("#entriesTable tbody");
        tbody.innerHTML = "";

        snapshot.forEach((doc) => {
          const data = doc.data();
          const row = document.createElement("tr");

          row.innerHTML = `
            <td>${data.customerName || ""}</td>
            <td>${data.phoneNumber || ""}</td>
            <td>${data.imei || ""}</td>
            <td>${data.offer || ""}</td>
            <td>${data.date || ""}</td>
            <td>${data.receiptUrl ? `<a href="${data.receiptUrl}" target="_blank">ðŸ“· View</a>` : "â€”"}</td>
          `;

          tbody.appendChild(row);
        });
      });
    }
  </script>
</body>
</html>